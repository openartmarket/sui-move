"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const assert_1 = __importDefault(require("assert"));
const artwork_1 = require("../src/artwork");
const artwork_shard_1 = require("../src/artwork_shard");
const config_1 = require("../src/config");
const end_request_voting_1 = require("../src/end_request_voting");
const vote_1 = require("../src/vote");
const vote_request_1 = require("../src/vote_request");
const test_helpers_1 = require("./test-helpers");
const artworkOptions = {
    signerPhrase: test_helpers_1.ADMIN_PHRASE,
    packageId: config_1.PACKAGE_ID,
    adminCapId: test_helpers_1.ADMIN_CAP_ID,
    totalSupply: 500,
    sharePrice: 10,
    multiplier: 100,
    name: "Mona Lisa",
    artist: "Leonardo da Vinci",
    creationDate: "1685548680595",
    description: "Choconta painting",
    currency: "NOK",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/e/ec/Mona_Lisa%2C_by_Leonardo_da_Vinci%2C_from_C2RMF_retouched.jpg/800px-Mona_Lisa%2C_by_Leonardo_da_Vinci%2C_from_C2RMF_retouched.jpg",
};
describe("DAO Voting structure", () => {
    let artworkId;
    beforeEach(async () => {
        artworkId = await (0, artwork_1.mintArtwork)(artworkOptions);
        await (0, artwork_shard_1.mintArtworkShard)({
            artworkId,
            signerPhrase: test_helpers_1.ADMIN_PHRASE,
            receiverAddress: test_helpers_1.ADMIN_ADDRESS,
            shares: 151,
            packageId: config_1.PACKAGE_ID,
            adminCapId: test_helpers_1.ADMIN_CAP_ID,
        });
        await (0, artwork_shard_1.mintArtworkShard)({
            artworkId,
            signerPhrase: test_helpers_1.ADMIN_PHRASE,
            receiverAddress: test_helpers_1.USER1_ADDRESS,
            shares: 249,
            packageId: config_1.PACKAGE_ID,
            adminCapId: test_helpers_1.ADMIN_CAP_ID,
        });
        await (0, artwork_shard_1.mintArtworkShard)({
            artworkId,
            signerPhrase: test_helpers_1.ADMIN_PHRASE,
            receiverAddress: test_helpers_1.USER2_ADDRESS,
            shares: 100,
            packageId: config_1.PACKAGE_ID,
            adminCapId: test_helpers_1.ADMIN_CAP_ID,
        });
    });
    it("can start a voting session", async () => {
        const voteRequest = await (0, vote_request_1.createVoteRequest)({
            artworkId,
            request: "Request to sell artwork to Museum",
            packageId: config_1.PACKAGE_ID,
            signerPhrase: test_helpers_1.ADMIN_PHRASE,
            adminCapId: test_helpers_1.ADMIN_CAP_ID,
        });
        assert_1.default.ok(voteRequest);
    });
    it("can vote as a shareholder", async () => {
        const voteRequest = await (0, vote_request_1.createVoteRequest)({
            artworkId,
            request: "Request to sell artwork to Museum",
            packageId: config_1.PACKAGE_ID,
            signerPhrase: test_helpers_1.ADMIN_PHRASE,
            adminCapId: test_helpers_1.ADMIN_CAP_ID,
        });
        assert_1.default.ok(voteRequest);
        const userVote = await (0, vote_1.vote)({
            artworkId,
            voteRequest,
            voterAccount: test_helpers_1.USER1_PHRASE,
            choice: true,
        });
        assert_1.default.ok(userVote);
    });
    it("cannot double vote as a shareholder", async () => {
        const voteRequest = await (0, vote_request_1.createVoteRequest)({
            artworkId,
            request: "Request to sell artwork to Museum",
            packageId: config_1.PACKAGE_ID,
            signerPhrase: test_helpers_1.ADMIN_PHRASE,
            adminCapId: test_helpers_1.ADMIN_CAP_ID,
        });
        assert_1.default.ok(voteRequest);
        const userVote = await (0, vote_1.vote)({
            artworkId,
            voteRequest,
            voterAccount: test_helpers_1.USER1_PHRASE,
            choice: true,
        });
        assert_1.default.ok(userVote);
        await assert_1.default.rejects((0, vote_1.vote)({ artworkId, voteRequest, voterAccount: test_helpers_1.USER1_PHRASE, choice: true }));
    });
    it("cannot vote if not a shareholder", async () => {
        const voteRequest = await (0, vote_request_1.createVoteRequest)({
            artworkId,
            request: "Request to sell artwork to Museum",
            packageId: config_1.PACKAGE_ID,
            signerPhrase: test_helpers_1.ADMIN_PHRASE,
            adminCapId: test_helpers_1.ADMIN_CAP_ID,
        });
        assert_1.default.ok(voteRequest);
        await assert_1.default.rejects((0, vote_1.vote)({ artworkId, voteRequest, voterAccount: test_helpers_1.USER3_PHRASE, choice: true }));
    });
    it("cannot vote if vote is closed", async () => {
        const voteRequest = await (0, vote_request_1.createVoteRequest)({
            artworkId,
            request: "Request to sell artwork to Museum",
            packageId: config_1.PACKAGE_ID,
            signerPhrase: test_helpers_1.ADMIN_PHRASE,
            adminCapId: test_helpers_1.ADMIN_CAP_ID,
        });
        assert_1.default.ok(voteRequest);
        const userVote = await (0, vote_1.vote)({
            artworkId,
            voteRequest,
            voterAccount: test_helpers_1.USER1_PHRASE,
            choice: true,
        });
        assert_1.default.ok(userVote);
        const endVoteRequest = await (0, end_request_voting_1.endRequestVoting)({
            voteRequest,
            packageId: config_1.PACKAGE_ID,
            signerPhrase: test_helpers_1.ADMIN_PHRASE,
            adminCapId: test_helpers_1.ADMIN_CAP_ID,
        });
        assert_1.default.ok(endVoteRequest);
        await assert_1.default.rejects((0, vote_1.vote)({ artworkId, voteRequest, voterAccount: test_helpers_1.USER1_PHRASE, choice: true }));
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGFvLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi90ZXN0L2Rhby50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsb0RBQTRCO0FBRTVCLDRDQUE2QztBQUM3Qyx3REFBd0Q7QUFDeEQsMENBQTJDO0FBQzNDLGtFQUE2RDtBQUU3RCxzQ0FBbUM7QUFDbkMsc0RBQXdEO0FBQ3hELGlEQVF3QjtBQUV4QixNQUFNLGNBQWMsR0FBRztJQUNyQixZQUFZLEVBQUUsMkJBQVk7SUFDMUIsU0FBUyxFQUFFLG1CQUFVO0lBQ3JCLFVBQVUsRUFBRSwyQkFBWTtJQUN4QixXQUFXLEVBQUUsR0FBRztJQUNoQixVQUFVLEVBQUUsRUFBRTtJQUNkLFVBQVUsRUFBRSxHQUFHO0lBQ2YsSUFBSSxFQUFFLFdBQVc7SUFDakIsTUFBTSxFQUFFLG1CQUFtQjtJQUMzQixZQUFZLEVBQUUsZUFBZTtJQUM3QixXQUFXLEVBQUUsbUJBQW1CO0lBQ2hDLFFBQVEsRUFBRSxLQUFpQjtJQUMzQixLQUFLLEVBQ0gsNkxBQTZMO0NBQ2hNLENBQUM7QUFFRixRQUFRLENBQUMsc0JBQXNCLEVBQUUsR0FBRyxFQUFFO0lBQ3BDLElBQUksU0FBaUIsQ0FBQztJQUN0QixVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsU0FBUyxHQUFHLE1BQU0sSUFBQSxxQkFBVyxFQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQzlDLE1BQU0sSUFBQSxnQ0FBZ0IsRUFBQztZQUNyQixTQUFTO1lBQ1QsWUFBWSxFQUFFLDJCQUFZO1lBQzFCLGVBQWUsRUFBRSw0QkFBYTtZQUM5QixNQUFNLEVBQUUsR0FBRztZQUNYLFNBQVMsRUFBRSxtQkFBVTtZQUNyQixVQUFVLEVBQUUsMkJBQVk7U0FDekIsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxJQUFBLGdDQUFnQixFQUFDO1lBQ3JCLFNBQVM7WUFDVCxZQUFZLEVBQUUsMkJBQVk7WUFDMUIsZUFBZSxFQUFFLDRCQUFhO1lB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cnR3b3JrIH0gZnJvbSBcIi4uL3NyYy9hcnR3b3JrXCI7XG5pbXBvcnQgeyBtaW50QXJ0d29ya1NoYXJkIH0gZnJvbSBcIi4uL3NyYy9hcnR3b3JrX3NoYXJkXCI7XG5pbXBvcnQgeyBQQUNLQUdFX0lEIH0gZnJvbSBcIi4uL3NyYy9jb25maWdcIjtcbmltcG9ydCB7IGVuZFJlcXVlc3RWb3RpbmcgfSBmcm9tIFwiLi4vc3JjL2VuZF9yZXF1ZXN0X3ZvdGluZ1wiO1xuaW1wb3J0IHsgQ3VycmVuY3kgfSBmcm9tIFwiLi4vc3JjL3R5cGVzXCI7XG5pbXBvcnQgeyB2b3RlIH0gZnJvbSBcIi4uL3NyYy92b3RlXCI7XG5pbXBvcnQgeyBjcmVhdGVWb3RlUmVxdWVzdCB9IGZyb20gXCIuLi9zcmMvdm90ZV9yZXF1ZXN0XCI7XG5pbXBvcnQge1xuICBBRE1JTl9BRERSRVNTLFxuICBBRE1JTl9DQVBfSUQsXG4gIEFETUlOX1BIUkFTRSxcbiAgVVNFUjFfQUREUkVTUyxcbiAgVVNFUjFfUEhSQVNFLFxuICBVU0VSMl9BRERSRVNTLFxuICBVU0VSM19QSFJBU0UsXG59IGZyb20gXCIuL3Rlc3QtaGVscGVyc1wiO1xuXG5jb25zdCBhcnR3b3JrT3B0aW9ucyA9IHtcbiAgc2lnbmVyUGhyYXNlOiBBRE1JTl9QSFJBU0UsXG4gIHBhY2thZ2VJZDogUEFDS0FHRV9JRCxcbiAgYWRtaW5DYXBJZDogQURNSU5fQ0FQX0lELFxuICB0b3RhbFN1cHBseTogNTAwLFxuICBzaGFyZVByaWNlOiAxMCxcbiAgbXVsdGlwbGllcjogMTAwLFxuICBuYW1lOiBcIk1vbmEgTGlzYVwiLFxuICBhcnRpc3Q6IFwiTGVvbmFyZG8gZGEgVmluY2lcIixcbiAgY3JlYXRpb25EYXRlOiBcIjE2ODU1NDg2ODA1OTVcIixcbiAgZGVzY3JpcHRpb246IFwiQ2hvY29udGEgcGFpbnRpbmdcIixcbiAgY3VycmVuY3k6IFwiTk9LXCIgYXMgQ3VycmVuY3ksXG4gIGltYWdlOlxuICAgIFwiaHR0cHM6Ly91cGxvYWQud2lraW1lZGlhLm9yZy93aWtpcGVkaWEvY29tbW9ucy90aHVtYi9lL2VjL01vbmFfTGlzYSUyQ19ieV9MZW9uYXJkb19kYV9WaW5jaSUyQ19mcm9tX0MyUk1GX3JldG91Y2hlZC5qcGcvODAwcHgtTW9uYV9MaXNhJTJDX2J5X0xlb25hcmRvX2RhX1ZpbmNpJTJDX2Zyb21fQzJSTUZfcmV0b3VjaGVkLmpwZ1wiLFxufTtcblxuZGVzY3JpYmUoXCJEQU8gVm90aW5nIHN0cnVjdHVyZVwiLCAoKSA9PiB7XG4gIGxldCBhcnR3b3JrSWQ6IHN0cmluZztcbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgYXJ0d29ya0lkID0gYXdhaXQgbWludEFydHdvcmsoYXJ0d29ya09wdGlvbnMpO1xuICAgIGF3YWl0IG1pbnRBcnR3b3JrU2hhcmQoe1xuICAgICAgYXJ0d29ya0lkLFxuICAgICAgc2lnbmVyUGhyYXNlOiBBRE1JTl9QSFJBU0UsXG4gICAgICByZWNlaXZlckFkZHJlc3M6IEFETUlOX0FERFJFU1MsXG4gICAgICBzaGFyZXM6IDE1MSxcbiAgICAgIHBhY2thZ2VJZDogUEFDS0FHRV9JRCxcbiAgICAgIGFkbWluQ2FwSWQ6IEFETUlOX0NBUF9JRCxcbiAgICB9KTtcbiAgICBhd2FpdCBtaW50QXJ0d29ya1NoYXJkKHtcbiAgICAgIGFydHdvcmtJZCxcbiAgICAgIHNpZ25lclBocmFzZTogQURNSU5fUEhSQVNFLFxuICAgICAgcmVjZWl2ZXJBZGRyZXNzOiBVU0VSMV9BRERSRVNTLFxuICAgICAgc2hhcmVzOiAyNDksXG4gICAgICBwYWNrYWdlSWQ6IFBBQ0tBR0VfSUQsXG4gICAgICBhZG1pbkNhcElkOiBBRE1JTl9DQVBfSUQsXG4gICAgfSk7XG4gICAgYXdhaXQgbWludEFydHdvcmtTaGFyZCh7XG4gICAgICBhcnR3b3JrSWQsXG4gICAgICBzaWduZXJQaHJhc2U6IEFETUlOX1BIUkFTRSxcbiAgICAgIHJlY2VpdmVyQWRkcmVzczogVVNFUjJfQUREUkVTUyxcbiAgICAgIHNoYXJlczogMTAwLFxuICAgICAgcGFja2FnZUlkOiBQQUNLQUdFX0lELFxuICAgICAgYWRtaW5DYXBJZDogQURNSU5fQ0FQX0lELFxuICAgIH0pO1xuICB9KTtcblxuICBpdChcImNhbiBzdGFydCBhIHZvdGluZyBzZXNzaW9uXCIsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCB2b3RlUmVxdWVzdCA9IGF3YWl0IGNyZWF0ZVZvdGVSZXF1ZXN0KHtcbiAgICAgIGFydHdvcmtJZCxcbiAgICAgIHJlcXVlc3Q6IFwiUmVxdWVzdCB0byBzZWxsIGFydHdvcmsgdG8gTXVzZXVtXCIsXG4gICAgICBwYWNrYWdlSWQ6IFBBQ0tBR0VfSUQsXG4gICAgICBzaWduZXJQaHJhc2U6IEFETUlOX1BIUkFTRSxcbiAgICAgIGFkbWluQ2FwSWQ6IEFETUlOX0NBUF9JRCxcbiAgICB9KTtcbiAgICBhc3NlcnQub2sodm90ZVJlcXVlc3QpO1xuICB9KTtcblxuICBpdChcImNhbiB2b3RlIGFzIGEgc2hhcmVob2xkZXJcIiwgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHZvdGVSZXF1ZXN0ID0gYXdhaXQgY3JlYXRlVm90ZVJlcXVlc3Qoe1xuICAgICAgYXJ0d29ya0lkLFxuICAgICAgcmVxdWVzdDogXCJSZXF1ZXN0IHRvIHNlbGwgYXJ0d29yayB0byBNdXNldW1cIixcbiAgICAgIHBhY2thZ2VJZDogUEFDS0FHRV9JRCxcbiAgICAgIHNpZ25lclBocmFzZTogQURNSU5fUEhSQVNFLFxuICAgICAgYWRtaW5DYXBJZDogQURNSU5fQ0FQX0lELFxuICAgIH0pO1xuICAgIGFzc2VydC5vayh2b3RlUmVxdWVzdCk7XG4gICAgY29uc3QgdXNlclZvdGUgPSBhd2FpdCB2b3RlKHtcbiAgICAgIGFydHdvcmtJZCxcbiAgICAgIHZvdGVSZXF1ZXN0LFxuICAgICAgdm90ZXJBY2NvdW50OiBVU0VSMV9QSFJBU0UsXG4gICAgICBjaG9pY2U6IHRydWUsXG4gICAgfSk7XG4gICAgYXNzZXJ0Lm9rKHVzZXJWb3RlKTtcbiAgfSk7XG5cbiAgaXQoXCJjYW5ub3QgZG91YmxlIHZvdGUgYXMgYSBzaGFyZWhvbGRlclwiLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3Qgdm90ZVJlcXVlc3QgPSBhd2FpdCBjcmVhdGVWb3RlUmVxdWVzdCh7XG4gICAgICBhcnR3b3JrSWQsXG4gICAgICByZXF1ZXN0OiBcIlJlcXVlc3QgdG8gc2VsbCBhcnR3b3JrIHRvIE11c2V1bVwiLFxuICAgICAgcGFja2FnZUlkOiBQQUNLQUdFX0lELFxuICAgICAgc2lnbmVyUGhyYXNlOiBBRE1JTl9QSFJBU0UsXG4gICAgICBhZG1pbkNhcElkOiBBRE1JTl9DQVBfSUQsXG4gICAgfSk7XG4gICAgYXNzZXJ0Lm9rKHZvdGVSZXF1ZXN0KTtcbiAgICBjb25zdCB1c2VyVm90ZSA9IGF3YWl0IHZvdGUoe1xuICAgICAgYXJ0d29ya0lkLFxuICAgICAgdm90ZVJlcXVlc3QsXG4gICAgICB2b3RlckFjY291bnQ6IFVTRVIxX1BIUkFTRSxcbiAgICAgIGNob2ljZTogdHJ1ZSxcbiAgICB9KTtcbiAgICBhc3NlcnQub2sodXNlclZvdGUpO1xuICAgIGF3YWl0IGFzc2VydC5yZWplY3RzKFxuICAgICAgdm90ZSh7IGFydHdvcmtJZCwgdm90ZVJlcXVlc3QsIHZvdGVyQWNjb3VudDogVVNFUjFfUEhSQVNFLCBjaG9pY2U6IHRydWUgfSlcbiAgICApO1xuICB9KTtcblxuICBpdChcImNhbm5vdCB2b3RlIGlmIG5vdCBhIHNoYXJlaG9sZGVyXCIsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCB2b3RlUmVxdWVzdCA9IGF3YWl0IGNyZWF0ZVZvdGVSZXF1ZXN0KHtcbiAgICAgIGFydHdvcmtJZCxcbiAgICAgIHJlcXVlc3Q6IFwiUmVxdWVzdCB0byBzZWxsIGFydHdvcmsgdG8gTXVzZXVtXCIsXG4gICAgICBwYWNrYWdlSWQ6IFBBQ0tBR0VfSUQsXG4gICAgICBzaWduZXJQaHJhc2U6IEFETUlOX1BIUkFTRSxcbiAgICAgIGFkbWluQ2FwSWQ6IEFETUlOX0NBUF9JRCxcbiAgICB9KTtcbiAgICBhc3NlcnQub2sodm90ZVJlcXVlc3QpO1xuICAgIGF3YWl0IGFzc2VydC5yZWplY3RzKFxuICAgICAgdm90ZSh7IGFydHdvcmtJZCwgdm90ZVJlcXVlc3QsIHZvdGVyQWNjb3VudDogVVNFUjNfUEhSQVNFLCBjaG9pY2U6IHRydWUgfSlcbiAgICApO1xuICB9KTtcblxuICBpdChcImNhbm5vdCB2b3RlIGlmIHZvdGUgaXMgY2xvc2VkXCIsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCB2b3RlUmVxdWVzdCA9IGF3YWl0IGNyZWF0ZVZvdGVSZXF1ZXN0KHtcbiAgICAgIGFydHdvcmtJZCxcbiAgICAgIHJlcXVlc3Q6IFwiUmVxdWVzdCB0byBzZWxsIGFydHdvcmsgdG8gTXVzZXVtXCIsXG4gICAgICBwYWNrYWdlSWQ6IFBBQ0tBR0VfSUQsXG4gICAgICBzaWduZXJQaHJhc2U6IEFETUlOX1BIUkFTRSxcbiAgICAgIGFkbWluQ2FwSWQ6IEFETUlOX0NBUF9JRCxcbiAgICB9KTtcbiAgICBhc3NlcnQub2sodm90ZVJlcXVlc3QpO1xuICAgIGNvbnN0IHVzZXJWb3RlID0gYXdhaXQgdm90ZSh7XG4gICAgICBhcnR3b3JrSWQsXG4gICAgICB2b3RlUmVxdWVzdCxcbiAgICAgIHZvdGVyQWNjb3VudDogVVNFUjFfUEhSQVNFLFxuICAgICAgY2hvaWNlOiB0cnVlLFxuICAgIH0pO1xuICAgIGFzc2VydC5vayh1c2VyVm90ZSk7XG4gICAgY29uc3QgZW5kVm90ZVJlcXVlc3QgPSBhd2FpdCBlbmRSZXF1ZXN0Vm90aW5nKHtcbiAgICAgIHZvdGVSZXF1ZXN0LFxuICAgICAgcGFja2FnZUlkOiBQQUNLQUdFX0lELFxuICAgICAgc2lnbmVyUGhyYXNlOiBBRE1JTl9QSFJBU0UsXG4gICAgICBhZG1pbkNhcElkOiBBRE1JTl9DQVBfSUQsXG4gICAgfSk7XG4gICAgYXNzZXJ0Lm9rKGVuZFZvdGVSZXF1ZXN0KTtcbiAgICBhd2FpdCBhc3NlcnQucmVqZWN0cyhcbiAgICAgIHZvdGUoeyBhcnR3b3JrSWQsIHZvdGVSZXF1ZXN0LCB2b3RlckFjY291bnQ6IFVTRVIxX1BIUkFTRSwgY2hvaWNlOiB0cnVlIH0pXG4gICAgKTtcbiAgfSk7XG59KTtcbiJdfQ==